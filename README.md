# Go Bangumi

支持远程一起看的网页家庭影院

✅ 远程一起看 （需要公网访问/虚拟局域网）

✅ 内置番剧搜索下载，边下边看（从种子站）

✅ 无需单独安装种子下载软件（使用 webtorrent 进行下载，无需 transmission, qbittorrent 等）

✅ 内容管理简单（通过文件系统进行）

## 安装

直接下载或者 `git clone https://github.com/eventlOwOp/go-bangumi --depth=1`

进入目录后运行 `yarn install` 或者 `npm install` 或者 `pnpm install` 并将 `config.default.js` 重命名为 `config.js` 后进行配置

之后使用 `node server.js` 运行后端，前端已经经过编译并位于仓库中（可使用 `pm2`, `screen` 等方式后台运行）

打开 `http://localhost:3000` 即可进入

使用远程一起看功能需要能够从公网访问（虚拟局域网也可）不在本教程范围

## 配置文件

请将 `config.default.js` 重命名为 `config.js` 后进行配置

| 配置项                | 功能                                                                         |
| :-------------------- | :--------------------------------------------------------------------------- |
| `rootPath`            | 番剧储存根目录                                                               |
| `axiosProxy`          | 配置访问种子站时的代理                                                       |
| `torrentClientConfig` | 使用 webtorrent 进行下载时的配置，请参见 webtorrent                          |
| `announceList`        | webtorrent 下载时使用的 annouce list                                         |
| `sources.search`      | 使用搜索功能搜索番剧的配置（指定字幕组功能未完成，默认 ANi，从动漫花园获取） |
| `sources.browse`      | 使用搜索功能浏览番剧的配置（指定字幕组功能未完成，默认 ANi，从动漫花园获取） |
| `sources.subNames`    | 用于指定字幕组功能，未完成                                                   |
| `sources.subId`       | 用于指定字幕组功能，未完成                                                   |
| `extMatcher`          | 指定下载和播放时被视为视频文件的后缀名                                       |

## 番剧管理

内置从种子站搜索下载番剧功能，同时支持自行下载

使用文件系统管理番剧，第一级子目录为番剧名称，第二级子目录为各集的视频文件

如 `bangumi` 为设定的储存根目录

```
bangumi
├── 邪神与厨二病少女 第三季
│   ├── [ANi] 邪神与厨二病少女 第三季（仅限港澳台地区） - 01 [1080P][Bilibili][WEB-DL][AAC AVC][CHT CHS][MP4]
│   ├── [ANi] 邪神与厨二病少女 第三季（仅限港澳台地区） - 02 [1080P][Bilibili][WEB-DL][AAC AVC][CHT CHS][MP4]
│   ├── ...
│   └── [ANi] 邪神与厨二病少女 第三季（仅限港澳台地区） - 12 [1080P][Bilibili][WEB-DL][AAC AVC][CHT CHS][MP4]
├── 邪神与厨二病少女 第二季
│   ├── 【幻樱字幕组】【4月新番】【邪神与厨二病少女 第二季 Jashin-chan Dropkick S2】【01】【GB_MP4】【1920X1080】
│   ├── ...
│   └── 【幻樱字幕组】【4月新番】【邪神与厨二病少女 第二季 Jashin-chan Dropkick S2】【12】【GB_MP4】【1920X1080】
├── 小马宝莉 s1
│   └── alist
└──  ...
```

在播放时会通过类似 git-diff 的算法来识别集数，并进行显示，所以如需此功能请保证同一目录下视频命名格式相同

### 支持 alist

目录下不存放视频文件，存放一个名为 `alist` 的文本文件，文本文件内容为该番剧在你的 alist 中挂载的 url 路径，编码为 utf-8

如你的视频文件路径为 `http://alist.example.com/alidrive/来自分享/小马宝莉 第1季【EquestriaCN】/104 踢苹时节.mp4`

且所有视频文件均在 `http://alist.example.com/alidrive/来自分享/小马宝莉 第1季【EquestriaCN】/` 下

则在你的 `alist` 文件中填入 `/alidrive/来自分享/小马宝莉 第1季【EquestriaCN】/`

## 播放界面

### 主界面

上部显示已下载的番剧，即储存根目录下的所有文件夹名

中间“添加”键，点击后进入番剧浏览页面

下部显示已经在进行的远程一起看会话，点击可加入

### 播放页

使用 artplayer 并进一步仿造 b 站 ui

| 支持功能                                 |
| :--------------------------------------- |
| ✅ 自动下一集（自动识别集数）            |
| ✅ 自动续播（记忆时长和集数）            |
| ✅ 按 k 快进 80 秒（适用于跳过片头片尾） |
| ✅ 按 f 切换全屏                         |
| ✅ 按 1 ~ 9 切换 1 ~ 9 倍速播放          |
| ❌ artplayer 热键                        |

右侧选集栏，导航界面依次为：返回主页，跳转该番剧更新页，开始一起看

### 番剧浏览页

下部列出根据配置 `sources.browse` 项搜索得到的番剧列表，并标出集数和发布时间

顶部第一行供下载种子使用，第一个框填写磁力链接，第二个框填写下载到根目录下哪个文件夹（即剧名是什么），默认 default

第一行右侧提示当前 webtorrent 下载和上传速度

顶部第二行根据配置 `sources.search` 项进行搜索

### 更新页

（即默认搜索了该番剧名称的浏览页）

### 一起看播放页

| 支持功能                          |
| :-------------------------------- |
| ✅ artplayer 热键                 |
| ✅ 一起看同步弹幕                 |
| ✅ 设置昵称                       |
| ✅ 弹幕，跳转，播放暂停事件的记录 |

分享一起看可以直接复制此时的 url 进行分享，格式为 `/together/XXXXXX` （六位随机数）

也可以在主页找到对应的剧名和集数进入

## 二次开发

todo

## 已知 bug

存在内存泄漏问题，可能导致稳定运行很长时间后崩溃，需要重启

远程一起看功能，在第一次创建一起看房间时可能加入一个并不存在的用户
